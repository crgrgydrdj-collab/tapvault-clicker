<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>TapVault</title>
  <style>
    :root{
      --bg:#0b1020;
      --card: rgba(10, 16, 30, .62);
      --card2: rgba(10, 16, 30, .45);
      --stroke: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --muted2: rgba(255,255,255,.45);
      --btn: rgba(90, 140, 255, .22);
      --btn2: rgba(255,255,255,.10);
      --ok: rgba(80, 220, 140, .22);
      --danger: rgba(255, 90, 90, .20);
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius: 22px;
      --radius2: 18px;
    }

    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background: var(--bg);
      overflow-x:hidden;
    }

    /* —Ñ–æ–Ω */
    .bg{
      position:fixed; inset:0;
      background:
        radial-gradient(1100px 700px at 20% 10%, rgba(170,80,255,.22), transparent 55%),
        radial-gradient(1000px 700px at 80% 20%, rgba(70,190,255,.18), transparent 55%),
        radial-gradient(900px 700px at 60% 90%, rgba(255,190,60,.20), transparent 55%),
        linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.65)),
        url("IMG_0907.jpeg");
      background-size: cover;
      background-position: center;
      filter: saturate(1.1) contrast(1.05);
      transform: scale(1.02);
    }
    .bg::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(900px 700px at 50% 30%, rgba(0,0,0,.08), rgba(0,0,0,.55));
    }

    /* safe areas */
    .wrap{
      position:relative;
      min-height:100%;
      padding: calc(env(safe-area-inset-top) + 18px) 16px calc(env(safe-area-inset-bottom) + 96px);
      max-width: 520px;
      margin: 0 auto;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 14px;
    }
    .brand{
      display:flex; flex-direction:column;
      gap:2px;
    }
    .brand h1{
      margin:0;
      font-size: 22px;
      letter-spacing: .2px;
      font-weight: 800;
      text-shadow: 0 10px 28px rgba(0,0,0,.35);
    }
    .brand .sub{
      margin:0;
      font-size: 13px;
      color:var(--muted);
    }
    .chip{
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.07);
      box-shadow: 0 10px 30px rgba(0,0,0,.20);
      display:flex; align-items:center; gap:10px;
      font-weight:700;
      font-size:13px;
      color: var(--muted);
      user-select:none;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.22);
      box-shadow: 0 0 0 6px rgba(255,255,255,.06);
    }
    .dot.on{
      background: rgba(80,220,140,.9);
      box-shadow: 0 0 0 6px rgba(80,220,140,.18);
    }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
    }

    .hero{
      padding: 16px 16px 14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }

    .score{
      display:flex;
      align-items:center;
      gap: 12px;
    }
    .score .icon{
      width:42px; height:42px;
      filter: drop-shadow(0 10px 22px rgba(0,0,0,.35));
    }
    .score .val{
      display:flex;
      flex-direction:column;
      gap: 2px;
    }
    .score .val .num{
      font-size: 34px;
      font-weight: 900;
      line-height: 1;
      letter-spacing: .4px;
    }
    .score .val .hint{
      font-size: 13px;
      color: var(--muted);
    }

    .miniStats{
      display:flex;
      flex-direction:column;
      gap: 8px;
      align-items:flex-end;
      color: var(--muted);
      font-size: 12.5px;
    }
    .pill{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.06);
    }

    .tapArea{
      padding: 14px 16px 16px;
      display:flex;
      flex-direction:column;
      gap: 14px;
      align-items:center;
    }

    .tapButton{
      width: 240px;
      height: 240px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: radial-gradient(120px 120px at 35% 30%, rgba(255,255,255,.18), transparent 60%),
                  radial-gradient(160px 160px at 60% 70%, rgba(80,160,255,.18), transparent 55%),
                  rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 22px 70px rgba(0,0,0,.50);
      position:relative;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .tapButton:active{
      transform: scale(.992);
      filter: brightness(1.04);
    }
    .tapStar{
      width: 180px;
      height: 180px;
      object-fit: contain;
      filter: drop-shadow(0 16px 34px rgba(0,0,0,.45));
      transform: translateY(2px);
    }
    .pop{
      position:absolute;
      font-weight:900;
      font-size: 18px;
      color: rgba(255,255,255,.92);
      text-shadow: 0 10px 25px rgba(0,0,0,.4);
      animation: pop 700ms ease-out forwards;
      pointer-events:none;
    }
    @keyframes pop{
      0%{ opacity:0; transform: translate(-50%, -20px) scale(.9); }
      20%{ opacity:1; }
      100%{ opacity:0; transform: translate(-50%, -86px) scale(1.02); }
    }

    .energyRow{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .energyLabel{
      font-size: 13px;
      color: var(--muted);
      min-width: 70px;
    }
    .bar{
      flex:1;
      height: 12px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      overflow:hidden;
    }
    .bar > i{
      display:block;
      height:100%;
      width: 50%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(80,160,255,.95), rgba(80,220,140,.85));
      box-shadow: 0 10px 25px rgba(0,0,0,.20);
    }
    .energyVal{
      font-size: 13px;
      color: var(--muted);
      min-width: 74px;
      text-align:right;
    }

    .btn{
      width:100%;
      border:1px solid var(--stroke);
      border-radius: 18px;
      padding: 14px 14px;
      font-weight: 900;
      font-size: 15px;
      color: var(--text);
      background: var(--btn);
      box-shadow: 0 16px 40px rgba(0,0,0,.35);
      cursor:pointer;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{ background: var(--btn2); font-weight: 800; color: var(--muted); }
    .btn.ok{ background: var(--ok); }
    .btn.danger{ background: var(--danger); }
    .small{
      font-size: 12.5px;
      color: var(--muted);
      line-height: 1.35;
      width:100%;
      text-align:center;
      padding: 0 6px;
    }

    /* —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
    .page{ display:none; }
    .page.active{ display:block; }

    /* –Ω–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è */
    .nav{
      position:fixed;
      left:0; right:0;
      bottom:0;
      padding: 10px 12px calc(env(safe-area-inset-bottom) + 10px);
      background: linear-gradient(180deg, transparent, rgba(0,0,0,.70));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .navInner{
      max-width: 520px;
      margin: 0 auto;
      background: rgba(10,16,30,.72);
      border:1px solid var(--stroke);
      border-radius: 18px;
      display:flex;
      gap: 8px;
      padding: 8px;
      box-shadow: 0 18px 55px rgba(0,0,0,.45);
    }
    .tab{
      flex:1;
      border:1px solid transparent;
      border-radius: 14px;
      padding: 10px 10px;
      color: var(--muted);
      background: transparent;
      font-weight: 900;
      font-size: 12.5px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      color: var(--text);
      border-color: var(--stroke);
      background: rgba(255,255,255,.08);
    }
    .tab svg{ opacity:.9; }

    /* –º–æ–¥–∞–ª–∫–∞ (–∞–Ω—Ç–∏–±–æ—Ç / —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è) */
    .modalBack{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background: rgba(0,0,0,.55);
      z-index: 50;
    }
    .modal{
      width:min(520px, 100%);
      background: rgba(10,16,30,.92);
      border:1px solid var(--stroke);
      border-radius: 20px;
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      padding: 14px;
    }
    .modal h3{ margin: 6px 0 6px; font-size: 16px; }
    .modal p{ margin: 0 0 12px; color: var(--muted); font-size: 13px; line-height: 1.35; }
    .row{
      display:flex; gap:10px; align-items:center;
    }
    input{
      width: 100%;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight: 800;
      outline:none;
    }
    .ghost{
      font-size: 12.5px;
      color: var(--muted2);
      margin-top: 10px;
      text-align:center;
    }
  </style>
</head>
<body>
  <div class="bg"></div>

  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <h1>TapVault</h1>
        <p class="sub">–¢–∞–ø–∞–π ‚≠ê ‚Äî –∫–æ–ø–∏ –∫–ª–∏–∫–∏ ‚Äî –º–µ–Ω—è–π –Ω–∞ –∑–≤—ë–∑–¥—ã</p>
      </div>
      <div class="chip" id="proChip">
        <span class="dot" id="proDot"></span>
        <span id="proText">PRO: OFF</span>
      </div>
    </div>

    <!-- –ì–õ–ê–í–ù–ê–Ø -->
    <section class="page active" id="page-home">
      <div class="card">
        <div class="hero">
          <div class="score">
            <img class="icon" src="IMG_0933.webp" alt="star"/>
            <div class="val">
              <div class="num" id="clicksText">0</div>
              <div class="hint">–ö–ª–∏–∫–∏ (–±–∞–ª–∞–Ω—Å)</div>
            </div>
          </div>
          <div class="miniStats">
            <div class="pill">–û–±–º–µ–Ω: <b>50 000</b> ‚Üí <b>50 ‚≠ê</b></div>
            <div class="pill">–≠–Ω–µ—Ä–≥–∏—è: <b id="energyMini">250/250</b></div>
          </div>
        </div>

        <div class="tapArea">
          <div class="tapButton" id="tapBtn" aria-label="tap">
            <img class="tapStar" src="IMG_0933.webp" alt="star"/>
          </div>

          <div class="energyRow">
            <div class="energyLabel">–≠–Ω–µ—Ä–≥–∏—è</div>
            <div class="bar"><i id="energyBar"></i></div>
            <div class="energyVal" id="energyText">250/250</div>
          </div>

          <button class="btn ok" id="exchangeBtn">–û–±–º–µ–Ω—è—Ç—å 50 000 –∫–ª–∏–∫–æ–≤ ‚Üí 50 ‚≠ê</button>
          <button class="btn secondary" id="promoBtn">–í–≤–µ—Å—Ç–∏ –ø—Ä–æ–º–æ–∫–æ–¥ (150‚ÇΩ)</button>

          <div class="small">
            –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥: –Ω–∞–ø–∏—à–∏ <b>@xarm0</b> ‚Äî —Ü–µ–Ω–∞ <b>150‚ÇΩ</b>.<br/>
            –ê–Ω—Ç–∏–±–æ—Ç-–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ä–∞–∑ –≤ 30‚Äì40 —Å–µ–∫—É–Ω–¥.
          </div>
        </div>
      </div>
    </section>

    <!-- –ü–†–û -->
    <section class="page" id="page-pro">
      <div class="card" style="padding:16px;">
        <h2 style="margin:0 0 8px; font-size:18px;">PRO –¥–æ—Å—Ç—É–ø</h2>
        <div style="color:var(--muted); font-size:13px; line-height:1.4;">
          PRO –¥–∞—ë—Ç —É—Å–∫–æ—Ä–µ–Ω–∏–µ –∏ —É–ª—É—á—à–µ–Ω–∏—è (–¥–æ–±–∞–≤–∏–º –¥–∞–ª—å—à–µ).<br><br>
          –¶–µ–Ω–∞: <b>150‚ÇΩ</b><br>
          –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥: –Ω–∞–ø–∏—à–∏ <b>@xarm0</b>
        </div>
        <div style="height:14px"></div>
        <button class="btn" id="openPromoFromPro">–í–≤–µ—Å—Ç–∏ –ø—Ä–æ–º–æ–∫–æ–¥</button>
      </div>
    </section>

    <!-- –û–ë–ú–ï–ù -->
    <section class="page" id="page-exchange">
      <div class="card" style="padding:16px;">
        <h2 style="margin:0 0 8px; font-size:18px;">–û–±–º–µ–Ω</h2>
        <div style="color:var(--muted); font-size:13px; line-height:1.4;">
          –¢–≤–æ–π –±–∞–ª–∞–Ω—Å –∫–ª–∏–∫–æ–≤: <b id="clicksText2">0</b><br>
          –î–ª—è –æ–±–º–µ–Ω–∞ –Ω—É–∂–Ω–æ: <b>50 000</b><br>
          –ù–∞–≥—Ä–∞–¥–∞: <b>50 ‚≠ê</b><br><br>
          –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ ‚Äî –∑–∞—è–≤–∫–∞ —É–π–¥—ë—Ç –≤ Worker –∏ –ø—Ä–∏–¥—ë—Ç —Ç–µ–±–µ –≤ Telegram —á–µ—Ä–µ–∑ –±–æ—Ç–∞.
        </div>
        <div style="height:14px"></div>
        <button class="btn ok" id="exchangeBtn2">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –æ–±–º–µ–Ω</button>
        <div class="ghost" id="exchangeStatus"></div>
      </div>
    </section>

    <!-- –õ–ò–î–ï–†–´ -->
    <section class="page" id="page-leaders">
      <div class="card" style="padding:16px;">
        <h2 style="margin:0 0 8px; font-size:18px;">–õ–∏–¥–µ—Ä—ã</h2>
        <div style="color:var(--muted); font-size:13px; line-height:1.4;">
          –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.
        </div>
      </div>
    </section>

  </div>

  <!-- –ù–∏–∂–Ω–∏–µ –≤–∫–ª–∞–¥–∫–∏ -->
  <div class="nav">
    <div class="navInner">
      <button class="tab active" data-tab="home">
        <span>–ì–ª–∞–≤–Ω–∞—è</span>
      </button>
      <button class="tab" data-tab="pro">
        <span>PRO</span>
      </button>
      <button class="tab" data-tab="exchange">
        <span>–û–±–º–µ–Ω</span>
      </button>
      <button class="tab" data-tab="leaders">
        <span>–õ–∏–¥–µ—Ä—ã</span>
      </button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞ / –∞–Ω—Ç–∏–±–æ—Ç–∞ -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <h3 id="modalTitle">–ü—Ä–æ–≤–µ—Ä–∫–∞</h3>
      <p id="modalDesc">–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.</p>
      <div class="row">
        <input id="modalInput" placeholder="–í–≤–µ–¥–∏—Ç–µ..." autocomplete="off"/>
        <button class="btn ok" style="width:auto; padding:12px 14px;" id="modalOk">OK</button>
      </div>
      <div class="ghost" id="modalHint"></div>
    </div>
  </div>

  <script>
    // ====== –ù–ê–°–¢–†–û–ô–ö–ò ======
    const WORKER_URL = "https://yellow-bush-d819.y7zwg8vpqt.workers.dev";
    const EXCHANGE_CLICKS = 50000;
    const EXCHANGE_STARS = 50;

    const ENERGY_MAX = 250;
    const TAP_COST = 1;          // 1 —ç–Ω–µ—Ä–≥–∏—è –∑–∞ —Ç–∞–ø
    const ENERGY_REGEN = 1;      // +1 —ç–Ω–µ—Ä–≥–∏—è
    const ENERGY_REGEN_MS = 1000;// —Ä–∞–∑ –≤ 1 —Å–µ–∫—É–Ω–¥—É

    // –∞–Ω—Ç–∏–±–æ—Ç: —Ä–∞–∑ –≤ 30‚Äì40 —Å–µ–∫
    const ANTIBOT_MIN_MS = 30000;
    const ANTIBOT_MAX_MS = 40000;

    // ====== TELEGRAM ======
    const tg = window.Telegram?.WebApp;
    const initData = tg?.initData || "";

    // ====== STATE (–ª–æ–∫–∞–ª—å–Ω–æ) ======
    const SKEY = "tapvault_state_v2";
    const now = () => Date.now();

    function loadState(){
      try{
        const raw = localStorage.getItem(SKEY);
        if(!raw) return { clicks:0, energy:ENERGY_MAX, pro:false, lastEnergyAt: now() };
        const s = JSON.parse(raw);
        if(typeof s.clicks!=="number") s.clicks = 0;
        if(typeof s.energy!=="number") s.energy = ENERGY_MAX;
        if(typeof s.pro!=="boolean") s.pro = false;
        if(typeof s.lastEnergyAt!=="number") s.lastEnergyAt = now();
        return s;
      }catch{
        return { clicks:0, energy:ENERGY_MAX, pro:false, lastEnergyAt: now() };
      }
    }
    function saveState(){
      localStorage.setItem(SKEY, JSON.stringify(state));
    }

    let state = loadState();

    // ====== UI refs ======
    const clicksText = document.getElementById("clicksText");
    const clicksText2 = document.getElementById("clicksText2");
    const energyText = document.getElementById("energyText");
    const energyMini = document.getElementById("energyMini");
    const energyBar = document.getElementById("energyBar");
    const exchangeBtn = document.getElementById("exchangeBtn");
    const exchangeBtn2 = document.getElementById("exchangeBtn2");
    const exchangeStatus = document.getElementById("exchangeStatus");
    const tapBtn = document.getElementById("tapBtn");

    const proDot = document.getElementById("proDot");
    const proText = document.getElementById("proText");

    // modal
    const modalBack = document.getElementById("modalBack");
    const modalTitle = document.getElementById("modalTitle");
    const modalDesc  = document.getElementById("modalDesc");
    const modalInput = document.getElementById("modalInput");
    const modalOk    = document.getElementById("modalOk");
    const modalHint  = document.getElementById("modalHint");

    function format(n){
      return (n|0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }

    // ====== ENERGY regen ======
    function regenEnergy(){
      const t = now();
      const elapsed = t - state.lastEnergyAt;
      if(elapsed < ENERGY_REGEN_MS) return;

      const add = Math.floor(elapsed / ENERGY_REGEN_MS) * ENERGY_REGEN;
      if(add > 0){
        state.energy = Math.min(ENERGY_MAX, state.energy + add);
        state.lastEnergyAt = t;
        saveState();
        render();
      }
    }
    setInterval(regenEnergy, 700);

    // ====== Render ======
    function render(){
      clicksText.textContent = format(state.clicks);
      clicksText2.textContent = format(state.clicks);

      energyText.textContent = `${state.energy}/${ENERGY_MAX}`;
      energyMini.textContent = `${state.energy}/${ENERGY_MAX}`;

      const pct = Math.max(0, Math.min(1, state.energy / ENERGY_MAX));
      energyBar.style.width = `${Math.round(pct*100)}%`;

      // PRO chip
      proDot.classList.toggle("on", state.pro);
      proText.textContent = state.pro ? "PRO: ON" : "PRO: OFF";

      // exchange enable/disable
      const canExchange = state.clicks >= EXCHANGE_CLICKS;
      exchangeBtn.disabled = !canExchange;
      exchangeBtn2.disabled = !canExchange;
      exchangeBtn.style.opacity = canExchange ? "1" : ".55";
      exchangeBtn2.style.opacity = canExchange ? "1" : ".55";
    }
    render();

    // ====== Tap logic ======
    function doPop(x, y, text){
      const el = document.createElement("div");
      el.className = "pop";
      el.textContent = text;
      el.style.left = x + "px";
      el.style.top  = y + "px";
      tapBtn.appendChild(el);
      setTimeout(()=>el.remove(), 720);
    }

    function tap(clientX, clientY){
      if(antibotLocked) return;
      if(state.energy < TAP_COST) return;

      state.energy -= TAP_COST;
      state.clicks += 1;
      saveState();
      render();

      const rect = tapBtn.getBoundingClientRect();
      doPop(clientX - rect.left, clientY - rect.top, "+1");

      // –ª—ë–≥–∫–∞—è –≤–∏–±—Ä–∞ (–≤ Telegram)
      try{ tg?.HapticFeedback?.impactOccurred("light"); }catch{}
    }

    tapBtn.addEventListener("click", (e)=>{
      tap(e.clientX, e.clientY);
    }, {passive:true});

    // ====== Tabs ======
    const pages = {
      home: document.getElementById("page-home"),
      pro: document.getElementById("page-pro"),
      exchange: document.getElementById("page-exchange"),
      leaders: document.getElementById("page-leaders")
    };
    document.querySelectorAll(".tab").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        Object.values(pages).forEach(p=>p.classList.remove("active"));
        pages[btn.dataset.tab].classList.add("active");
        render();
      });
    });

    // ====== Anti-bot (–ø—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞) ======
    let antibotLocked = false;
    let antibotTimer = null;

    function randInt(a,b){ return Math.floor(a + Math.random()*(b-a+1)); }
    function scheduleAntibot(){
      if(antibotTimer) clearTimeout(antibotTimer);
      const delay = randInt(ANTIBOT_MIN_MS, ANTIBOT_MAX_MS);
      antibotTimer = setTimeout(showAntibot, delay);
    }

    function showModal({title, desc, placeholder, hint, onOk}){
      modalTitle.textContent = title;
      modalDesc.textContent = desc;
      modalInput.value = "";
      modalInput.placeholder = placeholder || "–í–≤–µ–¥–∏—Ç–µ...";
      modalHint.textContent = hint || "";
      modalBack.style.display = "flex";
      setTimeout(()=>modalInput.focus(), 80);

      const handler = ()=>{
        const val = (modalInput.value||"").trim();
        const res = onOk(val);
        if(res === true){
          modalBack.style.display = "none";
          modalOk.removeEventListener("click", handler);
        }else{
          modalHint.textContent = (typeof res === "string" ? res : "–ù–µ–≤–µ—Ä–Ω–æ, –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.");
          try{ tg?.HapticFeedback?.notificationOccurred("error"); }catch{}
        }
      };
      modalOk.addEventListener("click", handler);
    }

    function showAntibot(){
      antibotLocked = true;
      const a = randInt(2, 9);
      const b = randInt(2, 9);
      const answer = String(a*b);

      showModal({
        title: "–ê–Ω—Ç–∏–±–æ—Ç-–ø—Ä–æ–≤–µ—Ä–∫–∞",
        desc: `–°–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç ${a} √ó ${b}?`,
        placeholder: "–û—Ç–≤–µ—Ç",
        hint: "–≠—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç 2 —Å–µ–∫—É–Ω–¥—ã üôÇ",
        onOk: (val)=>{
          if(val === answer){
            antibotLocked = false;
            scheduleAntibot();
            try{ tg?.HapticFeedback?.notificationOccurred("success"); }catch{}
            return true;
          }
          return "–ù–µ–≤–µ—Ä–Ω–æ. –í–≤–µ–¥–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç.";
        }
      });
    }
    scheduleAntibot();

    // ====== Promo ======
    function askPromo(){
      showModal({
        title: "–ü—Ä–æ–º–æ–∫–æ–¥ (150‚ÇΩ)",
        desc: "–í—Å—Ç–∞–≤—å –ø—Ä–æ–º–æ–∫–æ–¥. –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ ‚Äî –Ω–∞–ø–∏—à–∏ @xarm0",
        placeholder: "PROMO-XXXX",
        hint: "",
        onOk: async (code)=>{
          if(!code) return "–í–≤–µ–¥–∏ –ø—Ä–æ–º–æ–∫–æ–¥.";
          const ok = await sendPromo(code);
          if(ok){
            state.pro = true;
            saveState();
            render();
            return true;
          }
          return "–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω.";
        }
      });
    }
    document.getElementById("promoBtn").addEventListener("click", askPromo);
    document.getElementById("openPromoFromPro").addEventListener("click", askPromo);

    // ====== Exchange ======
    async function sendExchange(){
      exchangeStatus.textContent = "–û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞—è–≤–∫—É‚Ä¶";

      // –≤–∞–∂–Ω–æ: MiniApp –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç –≤–Ω—É—Ç—Ä–∏ Telegram
      if(!initData){
        exchangeStatus.textContent = "–û—Ç–∫—Ä–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram (–∏–Ω–∞—á–µ –Ω–µ—Ç initData).";
        return;
      }
      if(state.clicks < EXCHANGE_CLICKS){
        exchangeStatus.textContent = "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–ª–∏–∫–æ–≤ –¥–ª—è –æ–±–º–µ–Ω–∞.";
        return;
      }

      try{
        const resp = await fetch(WORKER_URL + "/api/redeem", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({
            initData,
            clicksToSpend: EXCHANGE_CLICKS,
            starsToGive: EXCHANGE_STARS
          })
        });

        const data = await resp.json().catch(()=>null);

        if(resp.ok && data?.ok){
          // —Å–ø–∏—Å—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ (–∞ —Ä–µ–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ/–ø—Ä–æ–≤–µ—Ä–∫—É –¥–µ–ª–∞–µ–º –≤ Worker)
          state.clicks -= EXCHANGE_CLICKS;
          saveState();
          render();

          exchangeStatus.textContent = "‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram (–æ—Ç –±–æ—Ç–∞).";
          try{ tg?.HapticFeedback?.notificationOccurred("success"); }catch{}
        }else{
          exchangeStatus.textContent = "‚ùå –û—à–∏–±–∫–∞: " + (data?.error || "–Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É");
          try{ tg?.HapticFeedback?.notificationOccurred("error"); }catch{}
        }
      }catch(e){
        exchangeStatus.textContent = "‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å Worker URL –∏ –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.";
      }
    }

    exchangeBtn.addEventListener("click", ()=>{
      // –ø–µ—Ä–µ–∫–∏–¥—ã–≤–∞–µ–º –Ω–∞ –≤–∫–ª–∞–¥–∫—É ¬´–û–±–º–µ–Ω¬ª
      document.querySelector('.tab[data-tab="exchange"]').click();
      sendExchange();
    });
    exchangeBtn2.addEventListener("click", sendExchange);

    // ====== Worker calls: promo ======
    async function sendPromo(code){
      if(!initData) return false;
      try{
        const resp = await fetch(WORKER_URL + "/api/promo", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ initData, code })
        });
        const data = await resp.json().catch(()=>null);
        return !!(resp.ok && data?.ok);
      }catch{
        return false;
      }
    }

    // ====== Telegram UI tweaks ======
    try{
      tg?.ready?.();
      tg?.expand?.();
    }catch{}
  </script>
</body>
</html>
