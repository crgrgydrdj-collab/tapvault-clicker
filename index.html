<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
  <title>TapVault</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
      color:#fff;
      background:#0b1020;
    }
    .bg{
      position:fixed; inset:0;
      background:url("IMG_0907.jpeg") center/cover no-repeat;
      filter:saturate(1.1) contrast(1.05);
      transform:scale(1.03);
      z-index:-2;
    }
    .bg::after{
      content:"";
      position:absolute; inset:0;
      background:radial-gradient(80% 60% at 50% 20%, rgba(140,70,255,.35), rgba(0,0,0,.55)),
                 linear-gradient(180deg, rgba(0,0,0,.20), rgba(0,0,0,.70));
      z-index:-1;
    }

    .app{
      max-width:460px;
      margin:0 auto;
      min-height:100vh;
      padding:16px 14px 86px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-top:6px;
    }
    .title{
      font-size:26px;
      font-weight:800;
      letter-spacing:.2px;
      opacity:.95;
    }
    .pill{
      padding:8px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter:blur(10px);
      font-weight:700;
      font-size:13px;
      color:rgba(255,255,255,.88);
    }

    .card{
      margin-top:14px;
      border-radius:22px;
      background:rgba(0,0,0,.40);
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter:blur(10px);
      box-shadow:0 18px 40px rgba(0,0,0,.35);
      padding:16px;
    }

    .counterRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .counterLeft{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .starMini{
      width:34px; height:34px;
      filter:drop-shadow(0 10px 18px rgba(0,0,0,.35));
    }
    .count{
      font-size:36px;
      font-weight:900;
      line-height:1;
      letter-spacing:.4px;
    }
    .sub{
      margin-top:8px;
      color:rgba(255,255,255,.70);
      font-weight:600;
    }

    .tapArea{
      display:flex;
      justify-content:center;
      margin:18px 0 10px;
    }
    .bigStarBtn{
      width:230px;
      height:230px;
      border-radius:999px;
      border:none;
      background:radial-gradient(60% 60% at 50% 40%, rgba(255,215,120,.28), rgba(0,0,0,0));
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
    }
    .bigStarBtn:active{ transform:scale(.985) }
    .bigStarImg{
      width:170px;
      height:170px;
      user-select:none;
      -webkit-user-drag:none;
      filter:drop-shadow(0 18px 28px rgba(0,0,0,.45));
    }
    .spark{
      position:absolute;
      width:8px; height:8px;
      border-radius:50%;
      background:rgba(255,230,140,.95);
      box-shadow:0 0 18px rgba(255,230,140,.75);
      animation:spark 550ms ease-out forwards;
      pointer-events:none;
    }
    @keyframes spark{
      from{ transform:translate(0,0) scale(1); opacity:1 }
      to{ transform:translate(var(--dx), var(--dy)) scale(.2); opacity:0 }
    }

    .energyRow{
      margin-top:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      color:rgba(255,255,255,.78);
      font-weight:700;
    }
    .bar{
      margin-top:10px;
      height:12px;
      border-radius:999px;
      background:rgba(255,255,255,.12);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
    }
    .bar > div{
      height:100%;
      width:50%;
      background:linear-gradient(90deg, rgba(255,200,80,.95), rgba(255,150,30,.95));
      border-radius:999px;
      transition:width .25s ease;
    }

    .btn{
      width:100%;
      margin-top:14px;
      padding:14px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.35);
      color:#fff;
      font-weight:900;
      font-size:16px;
      cursor:pointer;
      backdrop-filter:blur(10px);
    }
    .btn.primary{
      background:linear-gradient(180deg, rgba(255,200,80,.28), rgba(0,0,0,.25));
      border-color:rgba(255,200,80,.35);
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    .tabs{
      position:fixed;
      left:0; right:0; bottom:0;
      padding:10px 12px 18px;
      background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.75));
    }
    .tabbar{
      max-width:460px;
      margin:0 auto;
      display:flex;
      gap:8px;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:8px;
      backdrop-filter:blur(12px);
    }
    .tab{
      flex:1;
      padding:10px 8px;
      border-radius:14px;
      border:1px solid transparent;
      background:transparent;
      color:rgba(255,255,255,.78);
      font-weight:900;
      cursor:pointer;
    }
    .tab.active{
      background:rgba(255,255,255,.10);
      border-color:rgba(255,255,255,.12);
      color:#fff;
    }

    .hidden{ display:none; }

    .note{
      margin-top:10px;
      color:rgba(255,255,255,.72);
      line-height:1.35;
      font-weight:700;
    }
    .small{
      font-size:13px;
      color:rgba(255,255,255,.70);
      font-weight:700;
    }

    .input{
      width:100%;
      margin-top:10px;
      padding:14px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.35);
      color:#fff;
      font-weight:800;
      outline:none;
    }

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:92px;
      background:rgba(0,0,0,.72);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 12px;
      border-radius:14px;
      max-width:90%;
      color:#fff;
      font-weight:800;
      display:none;
      backdrop-filter:blur(12px);
    }
  </style>
</head>

<body>
  <div class="bg"></div>
  <div class="app">
    <div class="topbar">
      <div class="title">TapVault</div>
      <div class="pill" id="proPill">PRO: OFF</div>
    </div>

    <!-- HOME -->
    <div id="screen-home">
      <div class="card">
        <div class="counterRow">
          <div class="counterLeft">
            <img class="starMini" src="IMG_0933.webp" alt="star">
            <div>
              <div class="count" id="count">0</div>
              <div class="small">Тапай звёздочку — копи клики</div>
            </div>
          </div>
        </div>

        <div class="tapArea">
          <button class="bigStarBtn" id="tapBtn" aria-label="tap">
            <img class="bigStarImg" src="IMG_0933.webp" alt="star">
          </button>
        </div>

        <div class="energyRow">
          <div>Энергия</div>
          <div><span id="energy">250</span>/<span id="energyMax">250</span></div>
        </div>
        <div class="bar"><div id="energyBar"></div></div>

        <button class="btn primary" id="exchangeBtn">Обменять 50 000 кликов → ⭐</button>
      </div>
    </div>

    <!-- PRO -->
    <div id="screen-pro" class="hidden">
      <div class="card">
        <div style="font-size:18px;font-weight:900;">PRO доступ</div>
        <div class="note">
          Чтобы получить промокод: напиши <b>@xarm0</b> — цена <b>150р</b>.
        </div>

        <input class="input" id="promoInput" placeholder="Ввести промокод (150р)" />
        <button class="btn" id="promoBtn">Активировать PRO</button>

        <div class="note">
          Антибот-проверка появляется раз в 30–40 секунд. Если не пройти — клики временно не начисляются.
        </div>
      </div>
    </div>

    <!-- EXCHANGE -->
    <div id="screen-exchange" class="hidden">
      <div class="card">
        <div style="font-size:18px;font-weight:900;">Обмен</div>
        <div class="note">
          Обмен доступен при наличии <b>50 000</b> кликов. Нажимаешь “Отправить заявку” — и мне прилетит заявка в Telegram.
        </div>

        <button class="btn primary" id="exchangeBtn2">Отправить заявку на вывод</button>
        <div class="small" style="margin-top:10px;opacity:.85;">
          Если открылось не из кнопки бота, Telegram не даст initData — тогда заявка не отправится.
        </div>
      </div>
    </div>

    <!-- LEADERS -->
    <div id="screen-leaders" class="hidden">
      <div class="card">
        <div style="font-size:18px;font-weight:900;">Лидеры</div>
        <div class="note">В разработке.</div>
      </div>
    </div>

  </div>

  <div class="tabs">
    <div class="tabbar">
      <button class="tab active" data-tab="home">Главная</button>
      <button class="tab" data-tab="pro">PRO</button>
      <button class="tab" data-tab="exchange">Обмен</button>
      <button class="tab" data-tab="leaders">Лидеры</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/** === НАСТРОЙКИ === **/
const WORKER_BASE = "https://yellow-bush-d819.y7zwg8vpqt.workers.dev";
const EXCHANGE_THRESHOLD = 50000;

const ENERGY_MAX = 250;
const ENERGY_REGEN_PER_SEC = 1;

// антибот раз в 30–40 сек
const ANTIBOT_MIN_MS = 30000;
const ANTIBOT_MAX_MS = 40000;

/** === СОСТОЯНИЕ === **/
let clicks = Number(localStorage.getItem("tv_clicks") || "0");
let energy = Number(localStorage.getItem("tv_energy") || String(ENERGY_MAX));
let pro = (localStorage.getItem("tv_pro") || "0") === "1";
let blockedByCaptcha = false;
let nextCaptchaAt = Date.now() + rand(ANTIBOT_MIN_MS, ANTIBOT_MAX_MS);

const $ = (id)=>document.getElementById(id);

function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(toast._tm);
  toast._tm = setTimeout(()=>t.style.display="none", 2200);
}

function rand(a,b){ return Math.floor(a + Math.random()*(b-a+1)); }

/** === TELEGRAM WEBAPP === **/
function getTG(){
  try{
    if (window.Telegram && Telegram.WebApp){
      Telegram.WebApp.ready();
      return Telegram.WebApp;
    }
  }catch(e){}
  return null;
}

function getInitData(){
  const tg = getTG();
  return tg?.initData || "";
}

/** === UI === **/
function render(){
  $("count").textContent = clicks.toLocaleString("ru-RU");
  $("energy").textContent = energy;
  $("energyMax").textContent = ENERGY_MAX;
  $("proPill").textContent = pro ? "PRO: ON" : "PRO: OFF";

  const pct = Math.max(0, Math.min(1, energy/ENERGY_MAX));
  $("energyBar").style.width = (pct*100).toFixed(1) + "%";

  // кнопки обмена активны только если есть клики
  const canExchange = clicks >= EXCHANGE_THRESHOLD;
  $("exchangeBtn").disabled = !canExchange;
  $("exchangeBtn2").disabled = !canExchange;

  localStorage.setItem("tv_clicks", String(clicks));
  localStorage.setItem("tv_energy", String(energy));
  localStorage.setItem("tv_pro", pro ? "1" : "0");
}

/** === ЭНЕРГИЯ === **/
setInterval(()=>{
  if (energy < ENERGY_MAX){
    energy = Math.min(ENERGY_MAX, energy + ENERGY_REGEN_PER_SEC);
    render();
  }
}, 1000);

/** === АНТИБОТ (простая математика) === **/
setInterval(()=>{
  if (Date.now() >= nextCaptchaAt){
    runCaptcha();
    nextCaptchaAt = Date.now() + rand(ANTIBOT_MIN_MS, ANTIBOT_MAX_MS);
  }
}, 800);

function runCaptcha(){
  if (blockedByCaptcha) return;
  blockedByCaptcha = true;

  const a = rand(2,9);
  const b = rand(2,9);
  const ans = String(a+b);

  // максимально просто, без лишних экранов
  const user = prompt(`Антибот-проверка: сколько будет ${a}+${b}?`);
  if (user === null){
    toast("Проверка отменена — клики временно не считаются.");
    // останется заблокировано пока не пройдёт следующая
    setTimeout(()=>blockedByCaptcha=false, 12000);
    return;
  }

  if (user.trim() === ans){
    toast("✅ Проверка пройдена");
    blockedByCaptcha = false;
  }else{
    toast("❌ Неверно. Повтори позже");
    setTimeout(()=>blockedByCaptcha=false, 12000);
  }
}

/** === ТАП === **/
$("tapBtn").addEventListener("click", (e)=>{
  if (blockedByCaptcha){
    toast("Сначала пройди антибот");
    return;
  }
  if (energy <= 0){
    toast("Энергия закончилась");
    return;
  }
  energy -= 1;
  clicks += 1;

  // искры
  const rect = e.currentTarget.getBoundingClientRect();
  for(let i=0;i<6;i++){
    const s = document.createElement("div");
    s.className = "spark";
    const dx = rand(-60,60) + "px";
    const dy = rand(-70,40) + "px";
    s.style.setProperty("--dx", dx);
    s.style.setProperty("--dy", dy);
    s.style.left = (rect.width/2 + rand(-18,18)) + "px";
    s.style.top  = (rect.height/2 + rand(-18,18)) + "px";
    e.currentTarget.appendChild(s);
    setTimeout(()=>s.remove(), 600);
  }

  render();
});

/** === ВКЛАДКИ === **/
const screens = {
  home: $("screen-home"),
  pro: $("screen-pro"),
  exchange: $("screen-exchange"),
  leaders: $("screen-leaders"),
};

document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const name = btn.dataset.tab;
    Object.values(screens).forEach(s=>s.classList.add("hidden"));
    screens[name].classList.remove("hidden");
  });
});

/** === ПРОМОКОД (отправляем на воркер) === **/
$("promoBtn").addEventListener("click", async ()=>{
  const code = $("promoInput").value.trim();
  if (!code) return toast("Введи промокод");

  const initData = getInitData();
  if (!initData){
    return alert("Открой мини-приложение через кнопку бота в Telegram. Сейчас Telegram не передал данные (initData).");
  }

  try{
    const r = await fetch(WORKER_BASE + "/api/promo", {
      method:"POST",
      headers:{ "content-type":"application/json" },
      body: JSON.stringify({ initData, code })
    });
    const j = await r.json();
    if (j.ok){
      pro = true;
      toast("PRO активирован ✅");
      $("promoInput").value = "";
      render();
    }else{
      alert(j.error || "Промокод не принят");
    }
  }catch(e){
    alert("Ошибка сети/воркера");
  }
});

/** === ОБМЕН (заявка в воркер) === **/
async function doExchange(){
  if (clicks < EXCHANGE_THRESHOLD){
    return toast("Нужно 50 000 кликов");
  }

  const initData = getInitData();
  if (!initData){
    return alert("Открой мини-приложение через кнопку бота в Telegram. Сейчас Telegram не передал initData.");
  }

  try{
    const r = await fetch(WORKER_BASE + "/api/exchange", {
      method:"POST",
      headers:{ "content-type":"application/json" },
      body: JSON.stringify({ initData, clicks: clicks })
    });
    const j = await r.json();
    if (j.ok){
      toast("Заявка отправлена ✅");
      // локально не обнуляем — пусть воркер подтвердит и вернёт новый баланс
      // но для простоты можно обнулить после ok:
      clicks = j.newClicks ?? 0;
      render();
    }else{
      alert(j.error || "Не получилось отправить заявку");
    }
  }catch(e){
    alert("Ошибка сети/воркера");
  }
}

$("exchangeBtn").addEventListener("click", doExchange);
$("exchangeBtn2").addEventListener("click", doExchange);

/** старт */
render();
</script>
</body>
</html>
