<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>TapVault</title>

  <style>
    *{margin:0;padding:0;box-sizing:border-box;user-select:none;-webkit-user-select:none}
    body{
      min-height:100vh;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      color:#fff;
      background:url("IMG_0907.jpeg") center/cover no-repeat fixed;
      display:flex; justify-content:center; align-items:center;
      position:relative; overflow:hidden;
    }
    body::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(1200px 600px at 50% 18%, rgba(255,255,255,.12), transparent 60%),
        linear-gradient(to bottom, rgba(0,0,0,.55), rgba(0,0,0,.78));
      pointer-events:none;
    }
    .app{
      position:relative; z-index:1;
      width:min(420px, 92vw);
      padding:18px;
    }
    .top{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:10px; opacity:.95;
    }
    .brand{font-weight:800; letter-spacing:.4px; font-size:18px}
    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(15,18,30,.45);
      backdrop-filter: blur(10px);
    }
    .panel{
      background:rgba(15,18,30,.55);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:16px;
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
    }
    .counter{
      font-size:34px; font-weight:900;
      margin-top:2px; margin-bottom:8px;
    }
    .sub{
      opacity:.85; font-size:13px;
      margin-bottom:10px;
    }
    .star{
      width:190px; height:190px;
      margin: 8px auto 6px;
      background:url("IMG_0933.webp") center/contain no-repeat;
      cursor:pointer;
      transition: transform .05s ease;
      filter: drop-shadow(0 14px 24px rgba(0,0,0,.55));
    }
    .star:active{ transform:scale(.93); }

    .barWrap{
      margin-top:12px;
      text-align:left;
    }
    .barLabel{font-size:12px; opacity:.9; margin-bottom:6px; display:flex; justify-content:space-between}
    .bar{
      height:10px;
      background:rgba(255,255,255,.10);
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(90,130,255,.9), rgba(140,220,255,.9));
    }

    .row{
      display:flex; gap:10px; margin-top:12px;
    }
    .btn{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(90,130,255,.35);
      color:#fff;
      font-weight:800;
    }
    .btn.secondary{ background:rgba(255,255,255,.08); }

    .hint{
      margin-top:10px;
      font-size:12px;
      opacity:.85;
      line-height:1.3;
    }

    /* anti-bot modal */
    .modalBack{
      position:fixed; inset:0; z-index:9999;
      background:rgba(0,0,0,.65);
      display:none; align-items:center; justify-content:center;
      padding:18px;
    }
    .modal{
      width:min(360px, 92vw);
      background:rgba(15,18,30,.92);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:16px;
      backdrop-filter: blur(10px);
      text-align:center;
    }
    .modal h3{font-size:16px; margin-bottom:8px}
    .modal p{opacity:.9; font-size:13px; margin-bottom:10px}
    .inp{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:#fff;
      outline:none;
      font-size:16px;
      text-align:center;
    }
    .modal .btn{margin-top:10px}
    .err{color:#ff9090; font-size:12px; margin-top:8px; min-height:16px}
  </style>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>

  <div class="app">
    <div class="top">
      <div class="brand">TapVault</div>
      <div class="pill" id="proPill">PRO: OFF</div>
    </div>

    <div class="panel">
      <div class="counter">⭐ <span id="balance">0</span></div>
      <div class="sub">Тапай звёздочку — копи клики — меняй на ⭐</div>

      <div class="star" id="star"></div>

      <div class="barWrap">
        <div class="barLabel">
          <span>Энергия</span>
          <span><b id="energyTxt">250</b>/<span id="energyMaxTxt">250</span></span>
        </div>
        <div class="bar"><div id="energyBar"></div></div>
      </div>

      <div class="row">
        <button class="btn" id="withdrawBtn">Обменять 50 000 кликов → ⭐</button>
      </div>
      <div class="row">
        <button class="btn secondary" id="promoBtn">Ввести промокод (150₽)</button>
      </div>

      <div class="hint">
        Чтобы получить промокод: напиши <b>@xarm0</b> — цена <b>150₽</b>.<br>
        Антибот-проверка появляется раз в 30–40 секунд.
      </div>
    </div>
  </div>

  <!-- anti-bot modal -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <h3>Проверка “не бот”</h3>
      <p id="captchaText">Реши пример:</p>
      <input class="inp" id="captchaInp" inputmode="numeric" placeholder="Ответ" />
      <button class="btn" id="captchaBtn">Проверить</button>
      <div class="err" id="captchaErr"></div>
    </div>
  </div>

<script>
(() => {
  const WORKER = "https://yellow-bush-d819.y7zwg8vpqt.workers.dev";

  const tg = window.Telegram?.WebApp;
  tg?.ready?.();

  const initData = tg?.initData || ""; // важно: worker проверяет это

  // UI
  const $bal = document.getElementById("balance");
  const $pro = document.getElementById("proPill");
  const $energyTxt = document.getElementById("energyTxt");
  const $energyMaxTxt = document.getElementById("energyMaxTxt");
  const $energyBar = document.getElementById("energyBar");
  const $star = document.getElementById("star");
  const $withdraw = document.getElementById("withdrawBtn");
  const $promo = document.getElementById("promoBtn");

  // anti-bot
  const $modalBack = document.getElementById("modalBack");
  const $captchaText = document.getElementById("captchaText");
  const $captchaInp = document.getElementById("captchaInp");
  const $captchaBtn = document.getElementById("captchaBtn");
  const $captchaErr = document.getElementById("captchaErr");

  let state = null;

  // локально копим нажатия и отправляем пачкой
  let pendingDelta = 0;
  let sendTimer = null;

  // антибот: каждые 30–40 сек
  let captchaOkUntil = Date.now() + rand(30,40)*1000;
  let captchaAnswer = null;
  let captchaLocked = false;

  function rand(a,b){ return Math.floor(a + Math.random()*(b-a+1)); }

  function setLocked(v){
    captchaLocked = v;
    $star.style.opacity = v ? 0.35 : 1;
    $star.style.pointerEvents = v ? "none" : "auto";
  }

  function openCaptcha(){
    setLocked(true);
    $captchaErr.textContent = "";
    $captchaInp.value = "";
    const a = rand(2,9), b = rand(2,9);
    captchaAnswer = a + b;
    $captchaText.textContent = `Реши пример: ${a} + ${b} = ?`;
    $modalBack.style.display = "flex";
    setTimeout(() => $captchaInp.focus(), 50);
  }

  function closeCaptcha(){
    $modalBack.style.display = "none";
    captchaOkUntil = Date.now() + rand(30,40)*1000;
    setLocked(false);
  }

  $captchaBtn.onclick = () => {
    const v = Number($captchaInp.value);
    if (v === captchaAnswer){
      closeCaptcha();
    } else {
      $captchaErr.textContent = "Неверно. Попробуй ещё раз.";
    }
  };

  function render(){
    if (!state) return;

    $bal.textContent = String(state.balance || 0);

    const now = Date.now();
    const isPro = (state.proUntil || 0) > now;
    $pro.textContent = "PRO: " + (isPro ? "ON" : "OFF");

    const maxE = state.maxEnergy || (isPro ? 500 : 250);
    const e = Math.min(maxE, Math.max(0, state.energy || 0));

    $energyTxt.textContent = String(e);
    $energyMaxTxt.textContent = String(maxE);

    const pct = maxE ? (e / maxE) * 100 : 0;
    $energyBar.style.width = pct.toFixed(1) + "%";
  }

  async function api(path, data){
    const res = await fetch(WORKER + path, {
      method: "POST",
      headers: {"content-type":"application/json"},
      body: JSON.stringify({ ...data, initData })
    });
    return await res.json();
  }

  async function loadState(){
    const r = await api("/api/state", {});
    if (!r.ok) throw new Error(r.error || "STATE_FAIL");
    state = r.state;
    render();
  }

  async function sendDelta(){
    if (pendingDelta <= 0) return;
    const d = pendingDelta;
    pendingDelta = 0;

    const r = await api("/api/tap", { delta: d });
    if (r.ok){
      state = r.state;
      render();
    }
  }

  function scheduleSend(){
    if (sendTimer) return;
    sendTimer = setTimeout(async () => {
      sendTimer = null;
      try { await sendDelta(); } catch(e){}
    }, 1200);
  }

  // тап
  $star.addEventListener("click", async () => {
    const now = Date.now();

    if (now > captchaOkUntil){
      openCaptcha();
      return;
    }
    if (!state) return;

    // локально копим + отправим пачкой
    pendingDelta += 1;
    scheduleSend();

    // быстрый локальный “отклик”
    state.balance = (state.balance || 0) + 1;
    state.energy = Math.max(0, (state.energy || 0) - 1);
    render();

    // если накопили много — отправим сразу
    if (pendingDelta >= 25){
      try { await sendDelta(); } catch(e){}
    }
  });

  // вывод
  $withdraw.addEventListener("click", async () => {
    $withdraw.disabled = true;
    try{
      await sendDelta();
      const r = await api("/api/withdraw", {});
      if (!r.ok){
        alert(r.error === "NOT_ENOUGH" ? "Не хватает кликов. Нужно 50 000." : ("Ошибка: " + r.error));
      } else {
        state = r.state;
        render();
        alert("Заявка отправлена ✅\nЖди, админ обработает и отправит ⭐");
      }
    } catch(e){
      alert("Ошибка связи. Проверь Worker/интернет.");
    } finally {
      $withdraw.disabled = false;
    }
  });

  // промо
  $promo.addEventListener("click", async () => {
    const code = prompt("Введи промокод:");
    if (!code) return;

    $promo.disabled = true;
    try{
      const r = await api("/api/promo", { code });
      if (!r.ok){
        const map = {
          INVALID_CODE: "Неверный промокод.",
          ALREADY_USED: "Этот промокод уже использован.",
          EMPTY_CODE: "Пустой код.",
        };
        alert(map[r.error] || ("Ошибка: " + r.error));
      } else {
        state = r.state;
        render();
        alert("PRO активирован ✅");
      }
    } catch(e){
      alert("Ошибка связи. Проверь Worker.");
    } finally {
      $promo.disabled = false;
    }
  });

  // авто-синк раз в 3 сек
  setInterval(async () => {
    try{
      if (Date.now() > captchaOkUntil && !captchaLocked) openCaptcha();
      await sendDelta();
      await loadState();
    } catch(e){}
  }, 3000);

  // старт
  (async () => {
    try{
      if (!initData){
        alert("Открой приложение из Telegram (WebApp initData пустой).");
        return;
      }
      await loadState();
      setLocked(false);
    } catch(e){
      alert("Не получилось загрузить состояние.\nПроверь BOT_TOKEN/ADMIN_CHAT_ID и KV binding.");
    }
  })();
})();
</script>

</body>
</html>
