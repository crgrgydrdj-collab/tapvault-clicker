<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"
  />
  <title>TapVault</title>

  <style>
    /* ===== Anti-zoom / tap feel ===== */
    *{
      box-sizing:border-box;
      -webkit-tap-highlight-color:transparent;
      -webkit-touch-callout:none;
      -webkit-user-select:none;
      user-select:none;
      touch-action:manipulation;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,Inter,Segoe UI,Roboto,Arial,sans-serif;
      color:#fff;
      overflow:hidden;
      background:#07070b;
    }

    /* ===== Background (your image + premium tint) ===== */
    .bg{
      position:fixed; inset:0;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(255,196,64,.18), transparent 60%),
        radial-gradient(900px 700px at 80% 20%, rgba(160,115,255,.18), transparent 55%),
        radial-gradient(900px 700px at 60% 90%, rgba(255,196,64,.14), transparent 60%),
        url("IMG_0907.jpeg") center/cover no-repeat;
      filter:saturate(1.05) contrast(1.05);
      transform:scale(1.02);
    }
    .bg::after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(800px 600px at 50% 0%, rgba(0,0,0,.28), transparent 60%),
        linear-gradient(to bottom, rgba(0,0,0,.35), rgba(0,0,0,.65));
    }

    /* ===== Layout ===== */
    .app{
      position:relative;
      height:100%;
      display:flex;
      flex-direction:column;
      max-width:560px;
      margin:0 auto;
      padding: env(safe-area-inset-top) 16px calc(92px + env(safe-area-inset-bottom)) 16px;
    }

    /* ===== Top bar ===== */
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 2px 12px 2px;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand .title{
      font-size:28px;
      font-weight:900;
      letter-spacing:.2px;
      line-height:1.05;
    }
    .brand .subtitle{
      font-size:12px;
      opacity:.72;
      letter-spacing:.2px;
    }

    .badge{
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      letter-spacing:.35px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.35);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }

    /* ===== Glass card (iOS-ish) ===== */
    .glass{
      border-radius:26px;
      border:1px solid rgba(255,255,255,.10);
      background:
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      box-shadow:
        0 24px 70px rgba(0,0,0,.55),
        inset 0 1px 0 rgba(255,255,255,.18);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }

    /* ===== Premium yellow under-glass glow ===== */
    .goldGlow{
      position:relative;
      overflow:hidden;
    }
    .goldGlow::before{
      content:"";
      position:absolute;
      inset:-120px -80px auto -80px;
      height:240px;
      background: radial-gradient(closest-side, rgba(255,196,64,.42), transparent 70%);
      pointer-events:none;
      filter: blur(2px);
    }
    .goldGlow::after{
      content:"";
      position:absolute;
      inset:auto -120px -140px -120px;
      height:260px;
      background: radial-gradient(closest-side, rgba(255,196,64,.22), transparent 70%);
      pointer-events:none;
    }

    /* ===== Screens ===== */
    .screen{ display:none; }
    .screen.active{ display:block; }

    /* ===== Main card ===== */
    .mainCard{
      padding:18px;
    }

    .balanceRow{
      display:flex;
      align-items:center;
      gap:12px;
      padding:8px 6px 6px 6px;
    }
    .coinIcon{
      width:42px; height:42px;
      border-radius:14px;
      background:rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 auto;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .coinIcon img{ width:26px; height:26px; }

    .balanceText{
      display:flex;
      flex-direction:column;
      line-height:1.05;
    }
    .balanceText .label{
      font-size:12px;
      opacity:.70;
      letter-spacing:.2px;
    }
    .balanceText .value{
      font-size:40px;
      font-weight:900;
      letter-spacing:.2px;
      margin-top:4px;
    }

    /* ===== Tap area ===== */
    .tapWrap{
      margin-top:14px;
      border-radius:22px;
      padding:18px 14px 16px 14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
    }

    .tapZone{
      width:100%;
      height:260px;
      border-radius:20px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      position:relative;
      overflow:hidden;
    }
    .tapZone::before{
      content:"";
      position:absolute;
      width:380px; height:380px;
      border-radius:50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,196,64,.22), transparent 55%);
      filter: blur(1px);
      opacity:.95;
    }

    .starBtn{
      width:168px; height:168px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      box-shadow:
        0 16px 40px rgba(0,0,0,.55),
        inset 0 1px 0 rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      transition: transform .06s ease;
      cursor:pointer;
    }
    .starBtn:active{ transform: scale(.98); }
    .starBtn img{
      width:118px; height:118px;
      object-fit:contain;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.55));
    }

    .hintRow{
      display:flex;
      justify-content:space-between;
      gap:12px;
      margin-top:12px;
      font-size:12px;
      opacity:.75;
      letter-spacing:.2px;
    }

    /* ===== Energy ===== */
    .energyBlock{
      margin-top:14px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.16);
    }
    .energyTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:12px;
      opacity:.82;
      letter-spacing:.2px;
    }
    .bar{
      margin-top:8px;
      height:10px;
      border-radius:999px;
      background: rgba(255,255,255,.14);
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:100%;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(255,196,64,.95), rgba(255,153,0,.95));
      box-shadow: 0 10px 20px rgba(255,170,32,.18);
    }

    /* ===== Action button ===== */
    .actionBtn{
      margin-top:14px;
      padding:14px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.30);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      font-weight:900;
      letter-spacing:.2px;
      cursor:pointer;
    }
    .actionBtn .sub{
      font-weight:700;
      font-size:12px;
      opacity:.72;
      margin-top:2px;
    }
    .actionBtn .right{
      font-size:14px;
      opacity:.9;
      padding:8px 10px;
      border-radius:14px;
      background: rgba(255,196,64,.16);
      border:1px solid rgba(255,196,64,.25);
    }

    /* ===== PRO screen ===== */
    .proCard, .exCard, .leadCard{
      padding:18px;
    }
    .h2{
      font-size:18px;
      font-weight:900;
      margin:0 0 10px 0;
      letter-spacing:.2px;
    }
    .p{
      margin:0;
      font-size:13px;
      line-height:1.35;
      opacity:.82;
    }
    .field{
      margin-top:14px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .input{
      width:100%;
      padding:14px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color:#fff;
      outline:none;
      font-size:15px;
      user-select:text;
      -webkit-user-select:text;
      touch-action:manipulation;
    }
    .btnPrimary{
      margin-top:12px;
      width:100%;
      padding:14px 14px;
      border-radius:18px;
      border:1px solid rgba(255,196,64,.35);
      background: linear-gradient(180deg, rgba(255,196,64,.95), rgba(255,153,0,.95));
      color:#15110a;
      font-weight:1000;
      letter-spacing:.2px;
      text-align:center;
      cursor:pointer;
    }
    .smallNote{
      margin-top:10px;
      font-size:12px;
      opacity:.72;
      line-height:1.35;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      font-size:12px;
      font-weight:800;
      opacity:.9;
    }

    /* ===== Tabs bottom ===== */
    .tabs{
      position:fixed;
      left:0; right:0;
      bottom:0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom)) 12px;
      display:flex;
      justify-content:center;
      pointer-events:none;
    }
    .tabsInner{
      pointer-events:auto;
      width:min(560px, calc(100% - 0px));
      display:flex;
      gap:8px;
      padding:8px;
      border-radius:20px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.40);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
    }
    .tab{
      flex:1;
      padding:10px 10px;
      border-radius:16px;
      border:1px solid transparent;
      background: transparent;
      color: rgba(255,255,255,.75);
      font-weight:900;
      font-size:12px;
      letter-spacing:.2px;
      cursor:pointer;
    }
    .tab.active{
      color:#fff;
      background: rgba(255,255,255,.12);
      border-color: rgba(255,255,255,.12);
    }

    /* ===== Modal (Captcha will be built in Step 2 JS) ===== */
    .modal{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.72);
      z-index:9999;
      padding: 16px;
    }
    .modalBox{
      width:min(420px, 100%);
      border-radius:22px;
      padding:18px;
    }
    .modalBox .h2{ margin-bottom:6px; }
    .modalBox .p{ margin-bottom:12px; }

    /* ===== Tiny toast placeholder ===== */
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom: calc(92px + env(safe-area-inset-bottom));
      background: rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding:10px 12px;
      border-radius:14px;
      font-size:12px;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index:9998;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-6px);
    }
  </style>
</head>

<body>
  <div class="bg"></div>

  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="title">TapVault</div>
        <div class="subtitle">10 000 кликов → 50 Telegram Stars</div>
      </div>
      <div class="badge" id="proBadge">PRO: OFF</div>
    </div>

    <!-- MAIN -->
    <div class="screen active" id="screen-main">
      <div class="glass goldGlow mainCard">
        <div class="balanceRow">
          <div class="coinIcon">
            <img src="IMG_0933.webp" alt="star" />
          </div>
          <div class="balanceText">
            <div class="label">Баланс кликов</div>
            <div class="value" id="clicksValue">0</div>
          </div>
        </div>

        <div class="tapWrap">
          <div class="tapZone">
            <div class="starBtn" id="tapBtn" role="button" aria-label="tap">
              <img src="IMG_0933.webp" alt="tap star" />
            </div>
          </div>

          <div class="hintRow">
            <div>Тапай, чтобы фармить клики</div>
            <div>Энергия тратится</div>
          </div>

          <div class="energyBlock">
            <div class="energyTop">
              <span>Энергия</span>
              <span id="energyText">250 / 250</span>
            </div>
            <div class="bar"><div id="energyFill"></div></div>
          </div>

          <div class="actionBtn" id="exchangeBtn">
            <div>
              <div>Обменять</div>
              <div class="sub">10 000 кликов → 50 ⭐</div>
            </div>
            <div class="right" id="exchangeRight">Открыть</div>
          </div>
        </div>
      </div>
    </div>

    <!-- PRO -->
    <div class="screen" id="screen-pro">
      <div class="glass goldGlow proCard">
        <div class="h2">PRO доступ</div>
        <p class="p">
          PRO активируется по промокоду. Чтобы получить промокод — напиши <b>@xarm0</b>.
          Цена: <b>150₽</b>.
        </p>

        <div class="field">
          <span class="tag">Промокод</span>
          <input
  class="input"
  id="promoInput"
  type="text"
  inputmode="text"
  placeholder="TV-XXXX-XXXX"
  autocomplete="off"
/>
          <div class="btnPrimary" id="promoBtn">Активировать PRO</div>
        </div>

        <div class="smallNote">
          Антибот-проверка появляется случайно (примерно раз в 30–60 секунд).
          Пока не решишь пример — тап заблокирован.
        </div>
      </div>
    </div>

    <!-- EXCHANGE -->
    <div class="screen" id="screen-exchange">
      <div class="glass goldGlow exCard">
        <div class="h2">Обмен</div>
        <p class="p">
          Когда накопишь <b>10 000</b> кликов — можешь отправить заявку на обмен.
          После заявки тебе вручную отправят <b>50 Telegram Stars</b>.
        </p>

        <div class="actionBtn" id="sendWithdrawBtn">
          <div>
            <div>Отправить заявку</div>
            <div class="sub">10 000 → 50 ⭐ (вручную)</div>
          </div>
          <div class="right" id="withdrawRight">Отправить</div>
        </div>

        <div class="smallNote" id="exchangeNote">
          Подключение к Worker будет включено в Этапе 2 (скрипт).
        </div>
      </div>
    </div>

    <!-- LEADERS -->
    <div class="screen" id="screen-leaders">
      <div class="glass goldGlow leadCard">
        <div class="h2">Лидеры</div>
        <p class="p">В разработке.</p>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tabsInner">
      <button class="tab active" id="tabMain" type="button">Главная</button>
      <button class="tab" id="tabPro" type="button">PRO</button>
      <button class="tab" id="tabExchange" type="button">Обмен</button>
      <button class="tab" id="tabLeaders" type="button">Лидеры</button>
    </div>
  </div>

  <!-- Modal placeholder (Captcha UI will be activated in Step 2 JS) -->
  <div class="modal" id="captchaModal">
    <div class="glass goldGlow modalBox">
      <div class="h2">Антибот</div>
      <p class="p" id="captchaQuestion">Сколько будет 7 + 5?</p>
      <input
  class="input"
  id="captchaAnswer"
  type="number"
  inputmode="numeric"
  pattern="[0-9]*"
  placeholder="Ответ"
  autocomplete="off"
/>
      <div class="btnPrimary" id="captchaSubmit">Проверить</div>
      <div class="smallNote" id="captchaHint">Капча не закрывается. Нужно решить пример.</div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">Готово</div>

  <!-- STEP 2 will paste full JS here -->
  <script>
    (() => {
  /* =========================
     CONFIG
  ========================= */
  const WORKER_URL = "https://yellow-bush-d819.y7zwg8vpqt.workers.dev";
  const EXCHANGE_COST = 10000;  // 10 000 кликов
  const EXCHANGE_REWARD = 50;   // 50 Telegram Stars (вручную)
  const MAX_ENERGY = 250;

  // Base regen:
  const BASE_REGEN_PER_SEC = 1;   // +1 энергия/сек
  // PRO regen boost:
  const PRO_REGEN_PER_SEC = 2;    // +2 энергия/сек (быстрее)
  // Captcha timing:
  const CAPTCHA_MIN_MS = 30000;   // 30 sec
  const CAPTCHA_MAX_MS = 60000;   // 60 sec



  /* =========================
     DOM
  ========================= */
  const $ = (id) => document.getElementById(id);

  const proBadge = $("proBadge");
  const clicksValue = $("clicksValue");
  const tapBtn = $("tapBtn");
  const energyText = $("energyText");
  const energyFill = $("energyFill");

  const exchangeBtn = $("exchangeBtn");
  const exchangeRight = $("exchangeRight");
  const sendWithdrawBtn = $("sendWithdrawBtn");
  const withdrawRight = $("withdrawRight");
  const exchangeNote = $("exchangeNote");

  const promoInput = $("promoInput");
  const promoBtn = $("promoBtn");

  const tabMain = $("tabMain");
  const tabPro = $("tabPro");
  const tabExchange = $("tabExchange");
  const tabLeaders = $("tabLeaders");

  const screenMain = $("screen-main");
  const screenPro = $("screen-pro");
  const screenExchange = $("screen-exchange");
  const screenLeaders = $("screen-leaders");

  const captchaModal = $("captchaModal");
  const captchaQuestion = $("captchaQuestion");
  const captchaAnswer = $("captchaAnswer");
  const captchaSubmit = $("captchaSubmit");

  const toast = $("toast");

  /* =========================
     STATE (localStorage)
  ========================= */
  const LS = {
    clicks: "tv_clicks",
    energy: "tv_energy",
    pro: "tv_pro",
    usedCodes: "tv_used_codes",
    lastExit: "tv_last_exit",
    lastOnlineTick: "tv_last_online_tick",
    captchaRequired: "tv_captcha_required",
  };

  let clicks = Number(localStorage.getItem(LS.clicks) || 0);
  let energy = Number(localStorage.getItem(LS.energy) || MAX_ENERGY);
  let isPro = (localStorage.getItem(LS.pro) === "1");

  // for stable online regen
  let lastOnlineTick = Number(localStorage.getItem(LS.lastOnlineTick) || Date.now());
  // for offline regen
  let lastExit = Number(localStorage.getItem(LS.lastExit) || Date.now());

  // captcha runtime
  let captchaActive = (localStorage.getItem(LS.captchaRequired) === "1");
  let captchaExpected = null;
  let captchaTimer = null;

  /* =========================
     Telegram context (optional)
     НЕ ЛОМАЕМ браузер! (можно открывать и там)
  ========================= */
  const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
  if (tg) {
    try { tg.ready(); } catch {}
    try { tg.expand(); } catch {}
  }

  function getTGUserPayload() {
    if (!tg) return null;
    const u = tg.initDataUnsafe?.user || null;
    if (!u) return null;
    return {
      id: u.id,
      username: u.username || "",
      first_name: u.first_name || "",
      last_name: u.last_name || ""
    };
  }

  /* =========================
     UI helpers
  ========================= */
  function showToast(msg) {
    toast.textContent = msg;
    toast.classList.add("show");
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => toast.classList.remove("show"), 1700);
  }

  function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

  function updateUI() {
    clicksValue.textContent = String(clicks);

    // energy
    energy = clamp(energy, 0, MAX_ENERGY);
    energyText.textContent = `${energy} / ${MAX_ENERGY}`;
    energyFill.style.width = `${(energy / MAX_ENERGY) * 100}%`;

    // pro badge
    proBadge.textContent = `PRO: ${isPro ? "ON" : "OFF"}`;

    // exchange availability
    if (clicks >= EXCHANGE_COST) {
      exchangeRight.textContent = "Доступно";
      withdrawRight.textContent = "Отправить";
    } else {
      const need = EXCHANGE_COST - clicks;
      exchangeRight.textContent = `Нужно ещё ${need}`;
      withdrawRight.textContent = `Нужно ещё ${need}`;
    }
  }

  function setScreen(which) {
    [screenMain, screenPro, screenExchange, screenLeaders].forEach(s => s.classList.remove("active"));
    [tabMain, tabPro, tabExchange, tabLeaders].forEach(t => t.classList.remove("active"));

    if (which === "main") { screenMain.classList.add("active"); tabMain.classList.add("active"); }
    if (which === "pro") { screenPro.classList.add("active"); tabPro.classList.add("active"); }
    if (which === "exchange") { screenExchange.classList.add("active"); tabExchange.classList.add("active"); }
    if (which === "leaders") { screenLeaders.classList.add("active"); tabLeaders.classList.add("active"); }
  }

  /* =========================
     ENERGY: offline + online
     - оффлайн: +N энергии = секунд вне приложения
     - онлайн: каждый тик считаем прошедшие секунды и добавляем
     - никаких мгновенных "фуллов" без причины
  ========================= */
  function applyOfflineRegen() {
    const now = Date.now();
    const awaySec = Math.floor((now - lastExit) / 1000);
    if (awaySec > 0) {
      const rate = isPro ? PRO_REGEN_PER_SEC : BASE_REGEN_PER_SEC;
      energy = clamp(energy + awaySec * rate, 0, MAX_ENERGY);
    }
    lastExit = now;
    localStorage.setItem(LS.lastExit, String(lastExit));
  }

  function onlineRegenTick() {
    const now = Date.now();
    const diffSec = Math.floor((now - lastOnlineTick) / 1000);
    if (diffSec > 0) {
      const rate = isPro ? PRO_REGEN_PER_SEC : BASE_REGEN_PER_SEC;
      energy = clamp(energy + diffSec * rate, 0, MAX_ENERGY);
      lastOnlineTick = now;
      localStorage.setItem(LS.lastOnlineTick, String(lastOnlineTick));
      localStorage.setItem(LS.energy, String(energy));
      updateUI();
    }
  }

  /* =========================
     CAPTCHA: unskippable modal
     - появляется случайно 30–60 сек
     - нельзя закрыть кликом по фону
     - пока не решена: клики/кнопки блокируются
     - если "ушёл" и вернулся — снова показывает (captchaRequired)
  ========================= */
  function randInt(min, max) {
    return Math.floor(min + Math.random() * (max - min + 1));
  }

  function scheduleCaptcha() {
    clearTimeout(captchaTimer);
    const delay = randInt(CAPTCHA_MIN_MS, CAPTCHA_MAX_MS);
    captchaTimer = setTimeout(() => {
      showCaptcha();
    }, delay);
  }

  function buildCaptchaExample() {
    // примеры специально простые, но не однотипные
    const a = randInt(3, 19);
    const b = randInt(2, 17);
    const ops = ["+", "-", "+"];
    const op = ops[randInt(0, ops.length - 1)];
    let q = "", ans = 0;

    if (op === "+") { q = `${a} + ${b}`; ans = a + b; }
    else {
      // сделаем так, чтобы не было отрицательных
      const big = Math.max(a, b);
      const small = Math.min(a, b);
      q = `${big} - ${small}`;
      ans = big - small;
    }
    return { q, ans };
  }

  function showCaptcha() {
    if (captchaActive) return;
    captchaActive = true;
    localStorage.setItem(LS.captchaRequired, "1");

    const ex = buildCaptchaExample();
    captchaExpected = ex.ans;

    captchaQuestion.textContent = `Сколько будет ${ex.q}?`;
    captchaAnswer.value = "";
    captchaModal.style.display = "flex";

    // фокус на ввод (удобно)
    setTimeout(() => { try { captchaAnswer.focus(); } catch {} }, 350);
  }

  function hideCaptcha() {
    captchaActive = false;
    localStorage.setItem(LS.captchaRequired, "0");
    captchaExpected = null;
    captchaModal.style.display = "none";
    scheduleCaptcha();
  }

  function submitCaptcha() {
    const v = String(captchaAnswer.value || "").trim();
    if (!v) { showToast("Введи ответ"); return; }
    const n = Number(v);
    if (!Number.isFinite(n)) { showToast("Нужна цифра"); return; }

    if (n === captchaExpected) {
      showToast("Готово ✅");
      hideCaptcha();
    } else {
      showToast("Неверно. Попробуй ещё");
      captchaAnswer.value = "";
      try { captchaAnswer.focus(); } catch {}
    }
  }

  // Anti-skip без поломки клавиатуры на iOS:
// 1) клики по фону модалки не пробивают в приложение
// 2) но input остаётся кликабельным (клавиатура появляется)
captchaModal.addEventListener("click", (e) => {
  // если клик был НЕ по самому input и НЕ по кнопке — блокируем
  const t = e.target;
  const allow = (t === captchaAnswer) || (t === captchaSubmit) || (t.closest && (t.closest("#captchaAnswer") || t.closest("#captchaSubmit")));
  if (!allow) {
    e.preventDefault();
    e.stopPropagation();
  }
}, true);

// iOS Telegram: открываем клавиатуру по реальному тапу
captchaAnswer.addEventListener("touchstart", () => {
  captchaAnswer.focus();
}, { passive: true });

captchaAnswer.addEventListener("click", () => {
  captchaAnswer.focus();
});

  captchaSubmit.addEventListener("click", (e) => {
  e.preventDefault();
  submitCaptcha();
});
  captchaAnswer.addEventListener("keydown", (e) => {
    if (e.key === "Enter") submitCaptcha();
  });

  /* =========================
     TAPS
  ========================= */
  function handleTap() {
    if (captchaActive) {
      // никакой "капча пропала" — она на экране.
      // просто подсказка.
      showToast("Сначала реши капчу");
      return;
    }
    if (energy <= 0) {
      showToast("Нет энергии");
      return;
    }
    energy -= 1;
    clicks += 1;

    // persist lightly
    localStorage.setItem(LS.clicks, String(clicks));
    localStorage.setItem(LS.energy, String(energy));

    updateUI();
  }

  tapBtn.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();
    handleTap();
  });

  tapBtn.addEventListener("touchend", (e) => {
    e.preventDefault();
    e.stopPropagation();
    handleTap();
  }, { passive: false });

  /* =========================
     PRO (redeem)
     - локально: "одноразовый" на устройстве
     - глобально: потом сделаем через Worker /redeem
  ========================= */
  function getUsedCodes() {
    try {
      const arr = JSON.parse(localStorage.getItem(LS.usedCodes) || "[]");
      if (Array.isArray(arr)) return new Set(arr.map(String));
    } catch {}
    return new Set();
  }

  function saveUsedCodes(set) {
    localStorage.setItem(LS.usedCodes, JSON.stringify(Array.from(set)));
  }

  async function redeemViaWorker(code) {
    // Если Worker пока не поддерживает /redeem — поймаем ошибку и дадим локальный fallback.
    const payload = {
      code,
      tg_user: getTGUserPayload(),
      initData: tg ? (tg.initData || "") : "",
      ua: navigator.userAgent,
      ts: Date.now()
    };
    const r = await fetch(WORKER_URL + "/redeem", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    return await r.json();
  }

  async function activatePro() {
  const code = String(promoInput.value || "").trim().toUpperCase();
  if (!code) {
    showToast("Введи промокод");
    return;
  }

  showToast("Проверяем промокод…");

  const payload = {
    code,
    tg_user: getTGUserPayload(),
    initData: tg ? (tg.initData || "") : "",
    ua: navigator.userAgent,
    ts: Date.now()
  };

  try {
    const r = await fetch(WORKER_URL + "/redeem", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    let res = null;
    try {
      res = await r.json();
    } catch {}

    if (!r.ok || !res) {
      showToast("Ошибка сервера");
      return;
    }

    if (res.ok !== true) {
      showToast(res.reason || "Промокод недействителен");
      return;
    }

    // ✅ ПРО АКТИВИРОВАН
    isPro = true;
    localStorage.setItem(LS.pro, "1");
    updateUI();

    showToast("PRO активирован ✅");

  } catch (e) {
    showToast("Worker недоступен");
  }
}
  promoBtn.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();
    activatePro();
  });

  /* =========================
     Exchange: send request to Worker
  ========================= */
  async function sendWithdraw() {
    if (captchaActive) { showToast("Сначала реши капчу"); return; }

    if (clicks < EXCHANGE_COST) {
      showToast(`Нужно ещё ${EXCHANGE_COST - clicks}`);
      return;
    }

    withdrawRight.textContent = "Отправляем…";
    withdrawRight.style.opacity = "0.8";

    const payload = {
      type: "withdraw",
      clicks_cost: EXCHANGE_COST,
      reward_stars: EXCHANGE_REWARD,
      tg_user: getTGUserPayload(),
      initData: tg ? (tg.initData || "") : "",
      ua: navigator.userAgent,
      ts: Date.now()
    };

    try {
      const r = await fetch(WORKER_URL + "/withdraw", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });

      let res = null;
      try { res = await r.json(); } catch {}

      if (!r.ok || !res || res.ok !== true) {
        showToast("Ошибка отправки");
        withdrawRight.textContent = "Ошибка";
        withdrawRight.style.opacity = "1";
        return;
      }

      // списываем 10 000 кликов
      clicks -= EXCHANGE_COST;
      if (clicks < 0) clicks = 0;

      localStorage.setItem(LS.clicks, String(clicks));

      showToast("Заявка отправлена ✅");
      withdrawRight.textContent = "Отправлено";
      withdrawRight.style.opacity = "1";

      updateUI();
    } catch {
      showToast("Worker недоступен");
      withdrawRight.textContent = "Не удалось";
      withdrawRight.style.opacity = "1";
    }
  }

  sendWithdrawBtn.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();
    sendWithdraw();
  });

  /* =========================
     Navigation
  ========================= */
  tabMain.addEventListener("click", () => setScreen("main"));
  tabPro.addEventListener("click", () => setScreen("pro"));
  tabExchange.addEventListener("click", () => setScreen("exchange"));
  tabLeaders.addEventListener("click", () => setScreen("leaders"));

  exchangeBtn.addEventListener("click", () => setScreen("exchange"));

  /* =========================
     Persist on exit + handle offline regen
  ========================= */
  function persistAll() {
    localStorage.setItem(LS.clicks, String(clicks));
    localStorage.setItem(LS.energy, String(energy));
    localStorage.setItem(LS.pro, isPro ? "1" : "0");
    localStorage.setItem(LS.lastExit, String(Date.now()));
    localStorage.setItem(LS.lastOnlineTick, String(Date.now()));
  }

  window.addEventListener("beforeunload", persistAll);
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "hidden") persistAll();
  });

  /* =========================
     Init sequence
  ========================= */
  // 1) Offline regen
  applyOfflineRegen();

  // 2) Update exchange note (worker already connected)
  exchangeNote.textContent = `Worker подключён: заявки уходят на ${WORKER_URL}`;

  // 3) If captcha was required (saved), show it immediately
  if (captchaActive) {
    // rebuild example
    const ex = buildCaptchaExample();
    captchaExpected = ex.ans;
    captchaQuestion.textContent = `Сколько будет ${ex.q}?`;
    captchaAnswer.value = "";
    captchaModal.style.display = "flex";
    setTimeout(() => { try { captchaAnswer.focus(); } catch {} }, 60);
  } else {
    scheduleCaptcha();
  }

  // 4) Start online regen
  updateUI();
  setInterval(onlineRegenTick, 500);

  // 5) Save baseline tick now
  lastOnlineTick = Date.now();
  localStorage.setItem(LS.lastOnlineTick, String(lastOnlineTick));
})();
  </script>
</body>
</html>
